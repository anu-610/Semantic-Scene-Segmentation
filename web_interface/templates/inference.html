{% extends "base.html" %}

{% block title %}Inference Playground{% endblock %}

{% block content %}
<div style="max-width: 1100px; margin: 0 auto;">
    
    <div style="text-align: center; margin-bottom: 2rem;">
        <h1><i class="fa-solid fa-robot"></i> Inference Playground</h1>
        <p>Upload a street scene. <span style="color: var(--accent);">Optional:</span> Add a mask to calculate accuracy.</p>
    </div>

    <div class="card" id="upload-card">
        <div style="display: flex; gap: 2rem; justify-content: center; flex-wrap: wrap;">
            
            <div style="flex: 1; min-width: 300px;">
                <h3 style="text-align: center; margin-bottom: 1rem;">1. Input Image (Required)</h3>
                <div id="drop-zone-img" class="drop-zone">
                    <i class="fa-solid fa-image" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                    <p>Drag Image Here</p>
                    <input type="file" id="input-img" hidden accept="image/*">
                    <div id="img-name" class="file-name"></div>
                </div>
            </div>

            <div style="flex: 1; min-width: 300px;">
                <h3 style="text-align: center; margin-bottom: 1rem;">2. Ground Truth (Optional)</h3>
                <div id="drop-zone-mask" class="drop-zone dashed-grey">
                    <i class="fa-solid fa-layer-group" style="font-size: 2.5rem; margin-bottom: 0.5rem;"></i>
                    <p>Drag Mask Here</p>
                    <input type="file" id="input-mask" hidden accept="image/*">
                    <div id="mask-name" class="file-name"></div>
                </div>
            </div>
        </div>

        <button id="predict-btn" class="btn-primary" style="width: 100%; margin-top: 2rem; padding: 1rem; font-size: 1.1rem;" disabled>
            Run Ensemble Model
        </button>
    </div>

    <div id="loading" style="display: none; text-align: center; padding: 3rem;">
        <div class="spinner"></div>
        <h3 style="margin-top: 1rem;">Running 7 Models...</h3>
        <p>Calculating mIoU scores...</p>
    </div>

    <div class="card" id="result-card" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
            <h2><i class="fa-solid fa-square-poll-vertical"></i> Results</h2>
            <button onclick="location.reload()" style="background: var(--border); color: white; border: none; padding: 0.5rem 1rem; border-radius: 4px; cursor: pointer;">
                New Test
            </button>
        </div>

        <div id="score-banner" style="background: rgba(56, 189, 248, 0.1); border: 1px solid var(--accent); padding: 1rem; border-radius: 8px; margin-bottom: 1.5rem; display: none; text-align: center;">
            <span style="font-size: 1.2rem; color: var(--text-muted);">Mean IoU Score:</span>
            <span id="iou-score" style="font-size: 2rem; font-weight: bold; color: var(--accent); margin-left: 1rem;">0.0000</span>
        </div>

        <div class="result-grid">
            <div class="result-col">
                <span class="badge">Original Input</span>
                <img id="res-original" src="" alt="Original">
            </div>

            <div class="result-col">
                <span class="badge badge-accent">AI Prediction</span>
                <img id="res-prediction" src="" alt="Prediction">
            </div>

            <div class="result-col" id="col-gt" style="display: none;">
                <span class="badge badge-green">Ground Truth</span>
                <img id="res-gt" src="" alt="Ground Truth">
            </div>
        </div>

    </div>
</div>

<style>
    .drop-zone {
        border: 2px dashed var(--border);
        border-radius: 12px;
        padding: 2rem;
        text-align: center;
        background-color: rgba(30, 41, 59, 0.5);
        cursor: pointer;
        transition: all 0.3s;
        height: 200px;
        display: flex;
        flex-direction: column;
        justify-content: center;
        align-items: center;
    }
    .drop-zone:hover { border-color: var(--accent); background: rgba(56, 189, 248, 0.05); }
    .drop-zone.active { border-color: #4ade80; background: rgba(74, 222, 128, 0.1); }
    .dashed-grey { border-color: #475569; }

    .file-name { margin-top: 10px; color: var(--accent); font-size: 0.9rem; font-weight: bold; }

    /* Result Grid */
    .result-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
    }
    .result-col {
        background: black;
        border-radius: 8px;
        overflow: hidden;
        position: relative;
        border: 1px solid var(--border);
    }
    .result-col img { width: 100%; height: auto; display: block; }
    
    .badge {
        position: absolute; top: 10px; left: 10px;
        background: rgba(0,0,0,0.7); color: white;
        padding: 4px 10px; border-radius: 4px; font-size: 0.8rem;
        backdrop-filter: blur(4px);
    }
    .badge-accent { background: var(--accent); color: black; font-weight: bold; }
    .badge-green { background: #4ade80; color: black; font-weight: bold; }

    .spinner { border: 4px solid var(--border); border-top: 4px solid var(--accent); border-radius: 50%; width: 50px; height: 50px; animation: spin 1s linear infinite; margin: 0 auto; }
    @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
</style>

<script>
    // Elements
    const dropImg = document.getElementById('drop-zone-img');
    const inputImg = document.getElementById('input-img');
    const dropMask = document.getElementById('drop-zone-mask');
    const inputMask = document.getElementById('input-mask');
    const predictBtn = document.getElementById('predict-btn');
    
    // Setup Drag & Drop
    setupDrop(dropImg, inputImg, 'img-name');
    setupDrop(dropMask, inputMask, 'mask-name');

    function setupDrop(zone, input, nameId) {
        zone.addEventListener('click', () => input.click());
        zone.addEventListener('dragover', (e) => { e.preventDefault(); zone.classList.add('active'); });
        zone.addEventListener('dragleave', () => zone.classList.remove('active'));
        zone.addEventListener('drop', (e) => {
            e.preventDefault();
            if(e.dataTransfer.files.length) {
                input.files = e.dataTransfer.files;
                updateUI(nameId, input.files[0].name, zone);
            }
        });
        input.addEventListener('change', () => {
            if(input.files.length) updateUI(nameId, input.files[0].name, zone);
        });
    }

    function updateUI(elementId, text, zone) {
        document.getElementById(elementId).innerText = text;
        zone.classList.add('active');
        // Enable button only if image is present
        if(inputImg.files.length > 0) {
            predictBtn.disabled = false;
            predictBtn.style.backgroundColor = "var(--accent)";
        }
    }

    // Predict Logic
    predictBtn.addEventListener('click', async () => {
        const formData = new FormData();
        formData.append('file', inputImg.files[0]);
        if(inputMask.files.length > 0) {
            formData.append('mask', inputMask.files[0]);
        }

        document.getElementById('upload-card').style.display = 'none';
        document.getElementById('loading').style.display = 'block';

        try {
            const res = await fetch('/predict', { method: 'POST', body: formData });
            const data = await res.json();

            if(data.error) throw new Error(data.error);

            // Populate Images
            document.getElementById('res-original').src = data.original_url;
            document.getElementById('res-prediction').src = data.mask_url;

            // Handle Ground Truth
            if(data.gt_url) {
                document.getElementById('col-gt').style.display = 'block';
                document.getElementById('res-gt').src = data.gt_url;
                document.getElementById('score-banner').style.display = 'block';
                document.getElementById('iou-score').innerText = data.score;
            }

            document.getElementById('loading').style.display = 'none';
            document.getElementById('result-card').style.display = 'block';

        } catch (e) {
            alert("Error: " + e.message);
            location.reload();
        }
    });
</script>
{% endblock %}